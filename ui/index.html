<!DOCTYPE html>
<html lang="en" data-theme="light"> <!-- change to "dark" to default dark -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DAEDALUS #1043 — Ground Station</title>

  <!-- Libs -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1/dist/leaflet.js"></script>

  <!-- App styles -->
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="brandwrap">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="brand">DAEDALUS <span class="tag">#1043</span></div>
        <div class="sub">DDL-MissionControl</div>
      </div>
    </div>

    <div class="top-clocks">
      <div id="utcClock" class="clock-badge">UTC: 00:00:00</div>
      <div id="missionTime" class="clock-badge mission">Mission: 00:00:00</div>
    </div>

    <div class="status">
      <div id="connPill" class="pill">Disconnected</div>
      <button id="toggleTheme" class="btn sm ghost" title="Toggle light/dark (saves)">
        Theme
      </button>
    </div>
  </header>

  <!-- CONTROL STRIP -->
  <section class="strip" id="strip">
    <!-- Mode -->
    <div class="group">
      <div class="label">Mode</div>
      <label class="radio"><input type="radio" name="mode" id="modeBrowser" checked> Browser</label>
      <label class="radio"><input type="radio" name="mode" id="modeServer"> Server</label>
    </div>

    <!-- Browser Serial controls -->
    <div class="group" id="browserSerialPanel">
      <div class="label">Browser Serial</div>
      <select id="browserBaudSel" class="sel">
        <option>115200</option><option>57600</option><option>38400</option><option>19200</option><option>9600</option>
      </select>
      <button id="btnBrowserPick" class="btn">Pick Port…</button>
      <button id="btnConnectBrowser" class="btn primary">Connect</button>
      <button id="btnDisconnectBrowser" class="btn ghost">Disconnect</button>
    </div>

    <!-- Server controls -->
    <div class="group" id="serverPanel" style="display:none">
      <div class="label">Server Bridge</div>
      <input id="wsUrl" class="input" style="width:260px" value="ws://localhost:8787" />
      <button id="btnConnectServer" class="btn primary">Connect</button>
      <button id="btnDisconnectServer" class="btn ghost">Disconnect</button>
      <select id="portSel" class="sel wide" title="Server ports"></select>
      <select id="baudSel" class="sel">
        <option>115200</option><option>57600</option><option>38400</option><option>19200</option><option>9600</option>
      </select>
      <button id="applyPort" class="btn">Open</button>
      <button id="closePort" class="btn ghost">Close</button>
      <button id="refreshPorts" class="btn">Refresh</button>
    </div>

    <!-- Health -->
    <div class="group grow" id="healthKV">
      <div class="kv item"><div class="k">Link</div><div id="linkType" class="v big">—</div></div>
      <div class="kv item"><div class="k">Port</div><div id="portName" class="v big">—</div></div>
      <div class="kv item"><div class="k">Baud</div><div id="baudVal" class="v big">—</div></div>
      <div class="kv item"><div class="k">RX</div><div id="rxCount" class="v big ok">0</div></div>
      <div class="kv item"><div class="k">Lost</div><div id="lossCount" class="v big">0</div></div>
      <div class="kv item wide"><div class="k">CSV</div><div class="v" id="csvName">Flight_1043.csv</div></div>
      <div class="kv item wide"><div class="k">Last Command</div><div class="v big" id="healthLastCmd">—</div></div>
    </div>
  </section>

  <!-- MAIN GRID -->
  <main class="screen">
    <!-- CONTAINER -->
    <section class="panel container-panel">
      <div class="panel-title">
        <div>CONTAINER — <span id="containerState" class="state-text">STATE: —</span></div>
        <div class="chips">
          <span class="chip ok">OK: <b id="contHealthy">0</b></span>
          <span class="chip warn">Bad: <b id="contBad">0</b></span>
          <span class="chip batt"><span id="contBattPct">—</span>%</span>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chartbox"><div class="charttitle">Temperature (°C)</div><div id="chart-cont-temp"></div></div>
        <div class="chartbox"><div class="charttitle">Altitude (m)</div><div id="chart-cont-alt"></div></div>
        <div class="chartbox"><div class="charttitle">GPS Alt (m)</div><div id="chart-cont-gpsalt"></div></div>
        <div class="chartbox"><div class="charttitle">Voltage (V)</div><div id="chart-cont-volt"></div></div>
      </div>
    </section>

    <!-- PAYLOAD -->
    <section class="panel payload-panel">
      <div class="panel-title">
        <div>PAYLOAD — <span id="payloadState" class="state-text">STATE: —</span></div>
        <div class="chips">
          <span class="chip ok">OK: <b id="plHealthy">0</b></span>
          <span class="chip warn">Bad: <b id="plBad">0</b></span>
          <span class="chip batt"><span id="plBattPct">—</span>%</span>
        </div>
      </div>
      <div class="charts-grid horizontal">
        <div class="chartbox"><div class="charttitle">Gyroscope (deg/s) — R/P/Y</div><div id="chart-pl-gyro"></div></div>
        <div class="chartbox"><div class="charttitle">Acceleration (deg/s²) — R/P/Y</div><div id="chart-pl-acc"></div></div>
      </div>
    </section>

    <!-- MAP -->
    <section class="panel map-panel">
      <div class="panel-title">
        <div>GPS LOCATION <span id="gpsMiniTitle" class="gpsmini">—, — • sats: —</span></div>
        <div class="missionbar">
          <button id="btnStartMission" class="btn primary sm">Start Mission</button>
          <button id="toggleMapSize" class="btn sm ghost">Full</button>
          <div class="bigtime">T+ <b id="missionTimeBig">00:00:00</b></div>
        </div>
      </div>
      <div id="map" class="map"></div>
      <div class="gmaplink"><a id="gmapA" href="#" target="_blank" rel="noopener">Open in Google Maps</a></div>
    </section>

    <!-- LOGS -->
    <section class="panel logs-panel">
      <div class="panel-title">
        <div>Telemetry Control &amp; Logs</div>
        <div class="lastcmd"><div class="tit">Last Cmd</div><div id="lastCmd" class="val">—</div></div>
      </div>
      <div class="logs-content">
        <div class="cmdrow">
          <select id="quickCmd" class="sel wide"></select>
          <input id="manualCmd" class="input grow" placeholder="Manual command…"/>
          <button id="sendCmd" class="btn primary sm">Send</button>
          <button id="btnDemoPaste" class="btn sm ghost" title="Paste a sample telemetry line">Demo paste</button>
        </div>
        <div class="log-controls">
          <div class="left" style="display:flex;gap:8px;align-items:center">
            <label class="tiny">Latest</label>
            <input type="number" id="logN" min="50" max="5000" value="500" class="input" style="width:70px">
            <button id="refreshLogs" class="btn ghost sm">Refresh</button>
            <label class="chk"><input type="checkbox" id="autoScroll" checked> Auto</label>
            <label class="chk"><input type="checkbox" id="freeze"> Freeze</label>
            <label class="chk"><input type="checkbox" id="wrapLines"> Wrap</label>
          </div>
          <div class="right" style="display:flex;gap:8px;align-items:center">
            <button id="btnResetAllTop" class="btn danger sm">Reset All</button>
            <button id="btnSaveCSV" class="btn sm">CSV</button>
            <button id="copyLogs" class="btn sm">Copy</button>
          </div>
        </div>
        <div id="rawBox" class="rawbox" aria-live="polite"></div>
        <div id="jumpLive" class="jump-live" hidden><button id="jumpLiveBtn" class="btn primary sm">Jump to Live</button></div>
      </div>
    </section>
  </main>

  <!-- sync small→big time -->
  <script>
    (function(){
      const s=document.getElementById('missionTime'),b=document.getElementById('missionTimeBig');
      if(!s||!b)return;
      new MutationObserver(()=>{b.textContent=s.textContent.replace('Mission: ','')})
      .observe(s,{childList:true,characterData:true,subtree:true});
    })();

    // Theme toggle (persists)
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('dgs-theme');
      if (saved === 'light' || saved === 'dark') document.documentElement.setAttribute('data-theme', saved);
      btn?.addEventListener('click', ()=>{
        const cur = root.getAttribute('data-theme') || 'light';
        const next = cur === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        localStorage.setItem('dgs-theme', next);
      });
    })();
  </script>

  <script>window.DGS_TEAM_ID = 1043;</script>
  <script src="app.js"></script>
</body>
</html>
